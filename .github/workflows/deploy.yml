name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH into VPS and deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ~/3D-Printer-Slicer-API-for-FDM-and-SLA_JS
            git pull origin main
            
            # 1. Step: Build the new Docker image. This will use the updated code from the git pull. The build process will be cached, so only changed layers will be rebuilt, making it faster.
            sudo docker-compose build
            
            # 2. Step: Restart the container with the new image. The -d flag runs the container in detached mode, so it will run in the background.
            sudo docker-compose up -d
            
            # 3. Step: Resource management. Remove old, unused ("dangling") images to prevent filling up the VPS disk space.
            sudo docker image prune -f